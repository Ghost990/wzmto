<template>
  <div class="flight-selector-card">
    <div class="row">
      <div class="start-place col-12 col-sm-4">
        <h5>Departure</h5>
        <div class="input-group">
          <select id="departureSelect" name="departureSelect" v-model="selected" @change="selectedConnect" class="custom-select">
            <option v-once disabled :selected="selected" :value="selected">{{ selected }}</option>
            <option v-for="select in airports" v-bind:value="select">{{ select.shortName }}</option>
          </select>
        </div>
        <p>{{ selected.shortName }}</p>
      </div>
      <div class="end-place col-12 col-sm-4">
        <h5>Destination</h5>
        <div class="input-group">
          <select v-if="localConnections.length < 1" v-model="selectedDestination" @change="destinationSelect" class="custom-select" :disabled="!isFirstSelected">
            <option v-once disabled :selected="selectedDestination" :value="selectedDestination">{{ selectedDestination }}</option>
            <option v-for="select in selectedConnections" v-bind:value="select">{{ fulls(select.iata).shortName }}</option>
          </select>
          <select v-else v-model="selectedDestination" @change="destinationSelect" class="custom-select" :disabled="!isFirstSelected">
            <option v-once disabled :selected="selectedDestination" :value="selectedDestination">{{ selectedDestination }}</option>
            <option v-for="select in localConnections" v-bind:value="select">{{ selectedDestination }}</option>
          </select>
        </div>
        <div>
          {{ selectedDestination }}
        </div>
      </div>
      <div class="end-place col-12 col-sm-4">
        <h5>Date</h5>
        <div class="input-group">
          <flat-pickr
            v-model="departureDate"
            :config="config"
            class="form-control"
            :placeholder="getToday"
            name="date"
            :disabled="false"
          >
          </flat-pickr>
        </div>
        <p>{{ departureDate }}</p>
      </div>
      <br><br>
      <!--<div>-->
      <!--{{ flights }}-->
      <!--</div>-->
      <div v-for="flight in flights">
        {{ flight.flightNumber }}
      </div>
      <br><br>

      <!--<button @click="getSelectedFlights">SEND</button>-->
    </div>
    <div class="row">
      <div class="col-12 col-sm-6 offset-sm-3">
        <button class="wizz-button wizz-button-primary rounded" @click="getFlightDetails">GET</button>
        <button class="wizz-button wizz-button-primary rounded" @click="preselect()">data</button>
      </div>
    </div>
  </div>
</template>

<script>
  import axios from 'axios';
  import moment from 'moment';
  import { bus } from '../../main';

  export default {
    data() {
      return {
        selected: 'Please select...',
        selectedConnections: [],
        departureIata: '',
        destinationIata: '',
        selectedDestination: 'Please select...',
        departureDate: moment(new Date(), 'YYYY-MM-DD').format('YYYY-MM-DD'),
        destinationDate: '',
        longList: [],
        airports: [],
        startFlightSelected: {},
        flights: [],
        //endFlightSelected: null,
        isFirstSelected: false,
        findIata: [],
        savedInIatas: [],
        dict: [],
        objectArr: [],
        selectedIata: [],
        inSaved: [],
        localConnections: [],
        objs: [
          {iata: 'BUD', shortName: 'Budapest'},
          {iata: 'LON', shortName: 'London'}
        ],
        date: new Date(),
        // Get more form https://chmln.github.io/flatpickr/options/
        config: {
          wrap: true, // set wrap to true only when using 'input-group'
          altFormat: 'l, J F Y',
          altInput: true,
          dateFormat: 'Y-m-d',
          defaultDate: moment(new Date(), 'YYYY-MM-DD').format('YYYY-MM-DD')
        },
      }
    },
    computed: {
      getToday() {
        let vm = this;
        let date = new Date();
        return moment(date, 'YYYY-MM-DD').format('dddd, Do MMMM YYYY');
      },
      getDateVariant() {
        let value = this.$ls.get('departure');
        if (value !== null) {
          return this.departureDate = value[3];
        } else {
          return moment(new Date(), 'YYYY-MM-DD').format('YYYY-MM-DD');
        }
      },
      datePickerChanged() {
        return alert('changed');
      }
    },
    methods: {
      selectedConn(iata) {
        let value = this.$ls.get('departure');
        let vm = this;
        if (value !== null) {
          let obj = vm.airports.find(x => x.iata === iata);
          return obj;
        } else {
          let obj = vm.airports.find(x => x.iata === iata);
          return obj.shortName;
        }
      },
      preselect() {
        let value = this.$ls.get('departure');
        let callback = (val, oldVal, uri) => {
          console.log('localStorage change', val);
        };
        this.$ls.on('departure', callback);
        this.selected = value;
        console.log(value);
      },
      selectedConnect() {
        let vm = this;
        vm.selectedConnections = vm.selected.connections;
        vm.departureIata = vm.selected.iata;
        vm.isFirstSelected = true;
      },
      destinationSelect() {
        let vm = this;
        vm.destinationIata = vm.selectedDestination.iata;
      },
      fulls(iata) {
        let vm = this;
        return vm.airports.find(x => x.iata === iata);

      },
      getFlightDetails(url) {
        url = `https://mock-air.herokuapp.com/search?departureStation=${this.departureIata}&arrivalStation=${this.destinationIata}&date=${this.departureDate}`;
        axios.get(url)
          .then(response => {
            const data = response.data;
            let flightsArray = [];
            for (let key in data) {
              const flight = data[key];
              flightsArray.push(flight);
            }
            this.flights = flightsArray;
            this.$nextTick(() => {
              //this.$emit('selectedflight', flightsArray, this.selected.shortName, this.fulls(this.selectedDestination.iata).shortName, this.departureDate);
              bus.$emit('selectedflight', flightsArray, this.selected.shortName, this.fulls(this.selectedDestination.iata).shortName, this.departureDate, this.departureIata, this.destinationIata);
            });
          })
          .catch(error => console.log(error));
          // this.$cookie.set('departure', JSON.stringify(this.selected), 1);

          // this.$ls.set('destination', this.selectedDestination, 60 * 60 * 1000);
          let value = this.$ls.get('departure');
          let values = [this.selected, this.selectedConnections, this.fulls(this.selectedDestination.iata).shortName, url, this.departureDate];
          this.$ls.set('departure', values, 60 * 60 * 1000);
      }
    },
    created() {
      axios.get('https://mock-air.herokuapp.com/asset/stations')
        .then(response => {
          const data = response.data;
          let airportsArray = [];
          let dictArray = [];
          let connectionsArray = [];
          for (let key in data) {
            const airport = data[key];
            airportsArray.push(airport);
            let locDict = {
              iata: airport.iata,
              shortName: airport.shortName
            };
            dictArray.push(locDict);
          }
          this.airports = airportsArray;
          this.dict = dictArray;

        })
        .catch(error => console.log(error));

      let value = this.$ls.get('departure');
      let callback = (val, oldVal, uri) => {
        console.log('localStorage change', val);
      };
      this.$ls.on('departure', callback);

      if (value != null) {
        this.selected = value[0].shortName;
        this.selectedConnections = value[1];
        this.localConnections = value[1];
        this.selectedDestination = value[2];
        this.departureDate = value[4];
        this.isFirstSelected = true;
        let url = value[3];

        console.log(this.selectedConnections);

        axios.get(url)
          .then(response => {
            const data = response.data;
            let flightsArray = [];
            for (let key in data) {
              const flight = data[key];
              flightsArray.push(flight);
            }
            this.flights = flightsArray;
            this.$nextTick(() => {
              //this.$emit('selectedflight', flightsArray, this.selected.shortName, this.fulls(this.selectedDestination.iata).shortName, this.departureDate);
              bus.$emit('selectedflight', flightsArray, this.selected, this.selectedDestination, this.departureDate, this.departureIata, this.destinationIata);
            });
          })
          .catch(error => console.log(error));

        this.departureDate = value[3];
        console.log(this.departureDate);
      }
    }
  }
</script>

<style lang="scss" scoped>
  @import "../../styles/partials/variables";
  @import "../../styles/bootstrap/bootstrap";


  .flight-selector-card {
    border-radius: 3px;
    background: white;
    box-shadow: 0px 15px 25px 0px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
  }

  select {
    -webkit-appearance: none;
  }

  .custom-select {
    border: 2px solid $pink;
    &:focus {
      outline: none !important;
      border-color: $pink;
    }
  }



</style>
